<section class="mt-8">
  <div class="flex flex-col items-center gap-2 mb-8">
    <div class="flex items-center gap-3">
      <%= image_tag "logo.svg", class: "h-8 w-auto", alt: "rururu" %>
      <span class="text-2xl font-bold text-gray-700">@<%= current_user.name %></span>
      <%= image_tag current_user.avatar_url(variant: :thumb), class: "w-10 h-10 rounded-full", alt: current_user.name %>
      <span class="text-3xl font-bold bg-gradient-to-r from-purple-600 to-pink-600 bg-clip-text text-transparent">
        Wrapped <%= @year %>
      </span>
    </div>
    <% if @has_prev_year || @has_next_year %>
      <div class="flex gap-2 mt-2">
        <% if @has_prev_year %>
          <%= link_to my_wrapped_path(year: @year - 1), class: "text-gray-400 hover:text-gray-600 transition-colors" do %>
            <span class="material-symbols-outlined">chevron_left</span>
          <% end %>
        <% end %>
        <% if @has_next_year %>
          <%= link_to my_wrapped_path(year: @year + 1), class: "text-gray-400 hover:text-gray-600 transition-colors" do %>
            <span class="material-symbols-outlined">chevron_right</span>
          <% end %>
        <% end %>
      </div>
    <% end %>
  </div>

  <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-5 gap-4 mb-8">
    <% stat_configs = [
      { key: :pawprints, label: "Pawprints", icon: "pets", color: "from-orange-400 to-red-500" },
      { key: :subscriptions, label: "Subscriptions", icon: "bookmark_add", color: "from-blue-400 to-blue-600" },
      { key: :ownerships, label: "Owned Channels", icon: "add_circle", color: "from-green-400 to-green-600" },
      { key: :notification_webhooks, label: "Notification Webhooks", icon: "webhook", color: "from-purple-400 to-purple-600" },
      { key: :notification_emails, label: "Notification Emails", icon: "mail", color: "from-pink-400 to-pink-600" }
    ] %>
    <% stat_configs.each do |config| %>
      <div class="bg-white rounded-xl p-4 shadow-sm border border-gray-100">
        <div class="flex items-center gap-2 mb-2">
          <span class="material-symbols-outlined text-lg bg-gradient-to-r <%= config[:color] %> bg-clip-text text-transparent">
            <%= config[:icon] %>
          </span>
          <span class="text-xs text-gray-500 font-medium"><%= config[:label] %></span>
        </div>
        <div class="text-2xl font-bold text-gray-800">
          +<%= number_with_delimiter(@stats[config[:key]]) %>
        </div>
      </div>
    <% end %>
  </div>
</section>

<section class="mt-8">
  <h3 class="text-xl font-bold mb-4 text-gray-700 text-center">Monthly Activity</h3>

  <% max_count = @monthly_data.values.flat_map(&:values).max || 1 %>

  <div class="overflow-x-auto">
    <table class="w-full border-collapse">
      <thead>
        <tr>
          <th class="p-2 text-left text-sm font-medium text-gray-600 sticky left-0 bg-gray-50 z-10"></th>
          <% (1..12).each do |month| %>
            <th class="p-2 text-center text-xs font-medium text-gray-600 min-w-[40px]">
              <span class="hidden md:inline"><%= Date::ABBR_MONTHNAMES[month] %></span>
              <span class="md:hidden"><%= month %></span>
            </th>
          <% end %>
          <th class="p-2 text-center text-xs font-medium text-gray-600 min-w-[50px]">Total</th>
        </tr>
      </thead>
      <tbody>
        <% model_labels = {
          pawprints: { label: "Pawprints", icon: "pets" },
          subscriptions: { label: "Subscriptions", icon: "bookmark_add" }
        } %>
        <% @monthly_data.each do |model_name, months| %>
          <% row_max = months.values.max || 1 %>
          <tr class="border-t border-gray-100">
            <td class="p-2 text-sm font-medium text-gray-700 whitespace-nowrap sticky left-0 bg-white z-10">
              <div class="flex items-center gap-1">
                <span class="material-symbols-outlined text-sm text-gray-400"><%= model_labels[model_name][:icon] %></span>
                <span class="hidden sm:inline"><%= model_labels[model_name][:label] %></span>
              </div>
            </td>
            <% months.each do |month, count| %>
              <% intensity = row_max > 0 ? (count.to_f / row_max) : 0 %>
              <%
                bg_class = if count == 0
                  "bg-gray-50"
                elsif intensity <= 0.25
                  "bg-sky-100"
                elsif intensity <= 0.5
                  "bg-sky-200"
                elsif intensity <= 0.75
                  "bg-sky-300"
                else
                  "bg-sky-400"
                end
              %>
              <td class="p-1 text-center">
                <div class="<%= bg_class %> rounded-md p-2 min-h-[36px] flex items-center justify-center transition-all hover:scale-105 hover:shadow-sm" title="<%= Date::MONTHNAMES[month] %>: <%= count %>">
                  <span class="text-xs font-medium <%= count > 0 ? 'text-sky-800' : 'text-gray-400' %>">
                    <%= count > 0 ? count : '-' %>
                  </span>
                </div>
              </td>
            <% end %>
            <td class="p-1 text-center">
              <div class="bg-gray-100 rounded-md p-2 min-h-[36px] flex items-center justify-center">
                <span class="text-xs font-bold text-gray-700"><%= months.values.sum %></span>
              </div>
            </td>
          </tr>
        <% end %>
      </tbody>
    </table>
  </div>
</section>

<section class="mt-8 text-center">
  <p class="text-sm text-gray-400">
    Thanks for being part of rururu in <%= @year %>!
  </p>
</section>
