<% item_count_threshold = 3 %>

<h2 class="mt-[1em] mb-[0.5em] text-2xl font-bold">Unreads</h2>

<p class="flex flex-wrap w-full m-0 mb-2 p-0">Showing unreads from the last <%= @range_days %> days</p>
<div class="flex m-0 mb-4">
  <%= link_to("← " + (@range_days - 1).to_s + " days", unreads_path(@unreads_params.merge(range_days: @range_days - 1)), class: "block mr-1 py-1 px-3 bg-white border border-[#cccccc] rounded hover:bg-[#3d8bcd] hover:text-white") %>
  <%= link_to((@range_days + 1).to_s + " days →", unreads_path(@unreads_params.merge(range_days: @range_days + 1)), class: "block mr-1 py-1 px-3 bg-white border border-[#cccccc] rounded hover:bg-[#3d8bcd] hover:text-white") %>
</div>

<div class="flex flex-wrap gap-6 mb-4">
  <% if @subscription_tags.exists? %>
  <div>
    <div class="flex items-center gap-2 mb-2">
      <span class="text-sm font-medium text-gray-700">Tags</span>
      <%= link_to "(Manage)", my_subscriptions_path, class: "text-sm text-gray-500 hover:underline" %>
    </div>
    <div class="w-full m-0 overflow-x-auto whitespace-nowrap text-[0px]">
      <%= link_to("All", unreads_path(range_days: @range_days), class: "inline-block -mr-px py-3 px-4 border border-[#cccccc] text-center text-[13px] min-[769px]:px-6 min-[769px]:text-base first:rounded-l-md last:rounded-r-md hover:bg-[#3d8bcd] hover:text-white #{@subscription_tag || @channel_group ? 'bg-white text-gray-700' : 'bg-[#3d8bcd] text-white'}") %>
      <% @subscription_tags.each do |tag| %>
        <%= link_to(tag.name, unreads_path(range_days: @range_days, subscription_tag_id: tag.id), class: "inline-block -mr-px py-3 px-4 border border-[#cccccc] text-center text-[13px] min-[769px]:px-6 min-[769px]:text-base first:rounded-l-md last:rounded-r-md hover:bg-[#3d8bcd] hover:text-white #{@subscription_tag == tag ? 'bg-[#3d8bcd] text-white' : 'bg-white text-gray-700'}") %>
      <% end %>
    </div>
  </div>
  <% end %>

  <% if @channel_groups.exists? %>
  <div>
    <div class="flex items-center gap-2 mb-2">
      <span class="text-sm font-medium text-gray-700">Channel Groups</span>
    </div>
    <div class="w-full m-0 overflow-x-auto whitespace-nowrap text-[0px]">
      <% @channel_groups.each do |channel_group| %>
        <%= link_to(channel_group.name, unreads_path(range_days: @range_days, channel_group_id: channel_group.id), class: "inline-block -mr-px py-3 px-4 border border-[#cccccc] text-center text-[13px] min-[769px]:px-6 min-[769px]:text-base first:rounded-l-md last:rounded-r-md hover:bg-[#3d8bcd] hover:text-white #{@channel_group == channel_group ? 'bg-[#3d8bcd] text-white' : 'bg-white text-gray-700'}") %>
      <% end %>
    </div>
  </div>
  <% end %>
</div>

<% @channel_and_items.each do |channel, items| %>
  <div class="min-w-[400px] max-[768px]:min-w-[270px] m-0 p-0 border-b-[6px] border-b-[#dddddd] last:border-b-0 w-full">
    <h3 class="text-lg font-bold mt-2 [&_a]:flex [&_a]:items-center [&_a]:gap-[10px] [&_a]:p-[10px] [&_a]:transition-[0.25s] [&_a:hover]:bg-[rgba(255,255,255,0.75)] [&_a_span]:flex-1 max-[768px]:[&_a]:p-0 max-[768px]:[&_a]:py-[10px]">
      <%= link_to channel_path(channel) do %>
        <% if channel.image_url %>
          <div class="relative h-16 overflow-hidden [&_img]:h-full [&_img]:object-contain">
            <%= image_tag(channel.image_url, loading: "lazy") %>
          </div>
        <% end %>
        <span>
          <%= channel.title %>
        </span>
      <% end %>
    </h3>
    <%= turbo_frame_tag "channel_#{channel.id}_items" do %>
      <ul class="my-2 mx-0" id="channel_<%= channel.id %>_items_list">
        <% items.sort_by(&:published_at).reverse.take(item_count_threshold).each do |item| %>
          <li class="flex flex-wrap items-start border-t border-[#dddddd] border-t-[0.5px]" id="item_<%= item.id %>">
            <%= link_to(item.url, target: "_blank", class: "flex flex-wrap w-full !border-t-0 py-3 px-[10px] max-[768px]:py-4 max-[768px]:px-0 transition-[0.25s] hover:bg-[rgba(255,255,255,0.75)] min-[769px]:w-1/2") do %>
              <div class="relative w-24 h-16 mr-[10px] overflow-hidden max-[1200px]:w-24 max-[1200px]:h-16 max-[1200px]:mr-[10px]">
                <div class="image-blur-bg relative w-full h-full flex items-center justify-center bg-center bg-cover bg-no-repeat overflow-hidden" style="background-image: url('<%= item.image_url_or_placeholder %>')">
                  <%= image_tag(item.image_url_or_placeholder, loading: "lazy", class: "relative z-[2] w-full h-full object-contain") %>
                </div>
              </div>
              <div class="w-[calc(100%-126px)] mr-5 m-0 max-[768px]:w-[calc(100%-106px)] max-[768px]:m-0">
                <h4 class="font-bold">
                  <%= item.title %>
                </h4>
                <p>
                  <%= item.published_at.strftime("%Y-%m-%d %H:%M") %>
                </p>
                <p class="hidden line-clamp-1 line-clamp-2 line-clamp-3 line-clamp-4 line-clamp-5 line-clamp-6"></p>
                <p class="text-sm text-gray-500 line-clamp-<%= @item_summary_line_clamp %>">
                  <%= item.summary %>
                </p>
              </div>
              <% if item.audio_enclosure_url %>
                <div class="audio-player w-full mt-2 -mb-2 z-[3]">
                  <audio class="h-9" style="width: 100%;" src="<%= item.audio_enclosure_url %>" controls controlslist="nodownload"></audio>
                </div>
              <% end %>
            <% end %>
            <div class="w-[calc(50%-20px)] ml-5 m-0 py-3 px-0 max-[768px]:w-full max-[768px]:m-0 max-[768px]:mt-[-0.25em] max-[768px]:p-0 max-[768px]:pb-3">
              <div class="flex w-full m-0">
                <div class="relative top-0 right-0 w-[58px] [&_a]:inline-block [&_a]:w-[50px] [&_a]:m-0 [&_a]:py-[6px] [&_a]:px-0 [&_a]:text-center [&_a]:bg-[#999999] [&_a]:text-white [&_a]:rounded-sm [&_a:hover]:bg-[#aaaaaa]">
                  <%= link_to("Skip", item_skip_path(item), data: { turbo_method: :post }) %>
                </div>
                <div class="w-[calc(100%-60px)] max-[1200px]:w-[calc(100%-58px)] [&_p]:bg-white [&_p]:py-3 [&_p]:px-4 [&_p.button-to-unpaw]:bg-transparent [&_p.button-to-unpaw]:text-right [&_p.button-to-unpaw]:py-1 [&_p.button-to-unpaw]:px-0 [&_p.button-to-unpaw]:pt-1 max-[1200px]:[&_p.button-to-unpaw]:py-1 max-[1200px]:[&_p.button-to-unpaw]:pr-[5px] max-[1200px]:[&_p.button-to-unpaw]:pl-0 max-[1200px]:[&_p.button-to-unpaw]:pt-1">
                  <%= render(partial: "items/pawprint", locals: { item: item, pawprint: nil }) %>
                </div>
              </div>
            </div>
          </li>
        <% end %>
        <% if items.size > item_count_threshold %>
          <li id="load-more-<%= channel.id %>" class="pt-4 pb-3 px-[10px] border-t border-t-[#dddddd] border-t-[0.5px] text-center max-[768px]:py-3 max-[768px]:px-0">
            <div class="flex gap-2 justify-center">
              <%= link_to("Skip all items", channel_skips_path(channel_id: channel.id), data: { turbo_method: :post }, class: "inline-block leading-6 bg-[#999999] text-white py-[6px] px-3 rounded-sm hover:text-white hover:bg-[#aaaaaa]") %>
              <%= link_to("Load more unreads", my_unreads_channel_items_path(
                channel_id: channel.id,
                offset: item_count_threshold,
                limit: 3,
                range_days: @range_days
              ), data: { turbo_stream: true }, class: "inline-block leading-6 bg-[#3d8bcd] text-white py-[6px] px-3 rounded-sm hover:text-white hover:bg-[#5a9fd9]") %>
            </div>
          </li>
        <% end %>
      </ul>
    <% end %>
  </div>
<% end %>
