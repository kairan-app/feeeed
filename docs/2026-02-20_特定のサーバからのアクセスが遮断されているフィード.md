# 特定のサーバからのアクセスが遮断されているフィード

具体的にはHerokuからのHTTPリクエストを遮断しているサイトがあり、そうすると、2026年2月現在はHerokuで動かしている本アプリケーションにおいては、そこのフィードを扱うことができない。この問題に対してなんらかの回避策を講じたい。

## 検討した案

(A) ウェブのアプリケーション・サーバとは別の場所で別のプロセスを動かせるようにして、取得結果をアプリケーションに渡す
(B) 本アプリケーション用のHTTPプロキシをどこかに立てて、それ経由でアクセスできるようにする
(C) 本アプリケーションの利用者のリソースを借りて、新着チェックを行えるようにする

## 採用する方針: (B) Cloudflare Workers によるHTTPプロキシ

コード変更が最小限で済み、既存のジョブ構造をそのまま活かせるため(B)を採用する。
プロキシの実行基盤にはCloudflare Workersを使う。

### 構成

```
feeeed (Heroku)
  ├─ 通常のサイト → 直接アクセス
  └─ ブロック対象サイト → Cloudflare Worker (プロキシ) → 対象サイト
```

### feeeed側の変更

- `Httpc` クラスにプロキシ経由でリクエストする機能を追加
- 環境変数 `FEED_PROXY_URL` と `FEED_PROXY_SECRET` を追加
- `proxy_required_domains` テーブルでプロキシが必要なドメインを管理
  - 直接アクセスが失敗 → プロキシ経由でリトライ → 成功、となったドメインを記録
  - 記録済みドメインへのリクエストは最初からプロキシ経由にする
  - 手動でドメインリストを管理する必要がない

### Cloudflare Workers側

- ソースコードはリポジトリの `proxy/` ディレクトリに置く
- `proxy/` ディレクトリで `npx wrangler deploy` すればデプロイできる
- リクエストヘッダ `X-Proxy-Secret` で認証
- リクエストヘッダ `X-Target-URL` で取得先URLを受け取る
- レスポンスをそのまま中継し、リダイレクト後のURLを `X-Original-URL` で返す
- 無料プランの範囲内(10万リクエスト/日)で十分運用可能
