# 通知タイミング設定 & 定期実行タスク整理

## 背景

現在、NotificationWebhookやNotificationEmailは、JSTで日付が変わった直後にトリガしている。
これを、各利用者が「2時」とか「7時」とか設定できるようにしたい。

また、定期実行タスクの整理も合わせて行う。

## 現状の仕組み

### 対象モデル

| モデル | 所有者 | 用途 |
|--------|--------|------|
| NotificationWebhook | User | Slack/Discord に購読チャンネルの新着ItemやPawprintを通知 |
| NotificationEmail | User | メールで購読チャンネルの新着ItemやPawprintを通知 |
| ChannelGroupWebhook | User (+ ChannelGroup) | Channel Group の新着ItemをSlack/Discordに通知 |

### 定期実行タスクの現状

#### Heroku Scheduler（通知系3件）

| コマンド | スケジュール | JST換算 |
|----------|-------------|---------|
| `bin/rails runner "NotificationWebhook.notify"` | Daily at 3:00 PM UTC | 毎日 0:00 JST |
| `bin/rails runner "NotificationEmail.notify"` | Daily at 3:00 PM UTC | 毎日 0:00 JST |
| `bin/rails runner "ChannelGroupWebhook.notify"` | Hourly at :20 | 毎時 :20 |

#### Solid Queue recurring tasks（`config/recurring.yml` 5件）

| タスク名 | Job | スケジュール |
|----------|-----|-------------|
| `channel_fetcher` | `ChannelItemsFetcherJob` | 毎時 :10, :59 |
| `channel_interval_adjustment` | `ChannelIntervalAdjustmentJob` | 毎日 3:00am |
| `channel_schedule_adjustment` | `ChannelScheduleAdjustmentJob` | 毎日 4:00am |
| `solid_queue_cleanup` | `SolidQueueCleanupJob` | 毎日 4:30am |
| `daily_active_users_notifier` | `DailyActiveUsersNotifierJob` | 毎日 0:05am |

### 通知フロー（現状）

```
[Heroku Scheduler] → rails runner "Model.notify"
                      → find_each で全レコードを走査
                      → 各レコードに対して *NotifierJob を enqueue
                            → インスタンスの #notify を実行
                            → last_notified_at 以降のデータを取得して送信
                            → last_notified_at を更新
```

- `.notify` クラスメソッドは存在するが、Heroku Scheduler から `rails runner` で直接呼ばれている
- `config/recurring.yml` にはタスクが**未登録**
- Solid Queue の recurring task に移行し、Heroku Scheduler の通知系3件は削除する

### 関連ファイル

- `app/models/notification_webhook.rb` - mode: my_subscribed_items / my_pawprints
- `app/models/notification_email.rb` - mode: my_subscribed_items / my_pawprints（verified のみ対象）
- `app/models/channel_group_webhook.rb` - mode なし（Itemのみ）
- `app/jobs/notification_webhook_notifier_job.rb` - 個別レコードの通知実行
- `app/jobs/notification_email_notifier_job.rb` - 同上
- `app/jobs/channel_group_webhook_notifier_job.rb` - 同上
- `app/views/my/notification_settings/index.html.erb` - 設定画面（3セクション）
- `config/recurring.yml` - Solid Queue の定期実行タスク設定

## 設計

### A. 通知タイミング設定

#### 方針

- **対象**: NotificationWebhook と NotificationEmail のみ
  - ChannelGroupWebhook は毎時通知のため対象外
- **通知時刻の保存場所**: 各レコードに `notify_hour` カラム (integer) を追加
  - レコードごとに個別設定可能（例: Slackは7時、Emailは12時）
  - デフォルト値 `0`（午前0時JST）で既存動作を維持
- **スケジューリング**: Solid Queue recurring task を毎時実行 → `.notify` 内で `Time.current.hour` フィルタ
- **タイムゾーン**: `config.time_zone = "Tokyo"` 設定済みのためJST固定でOK

#### 実装ステップ

##### 1. マイグレーション

notification_webhooks, notification_emails の2テーブルに `notify_hour` (integer, default: 0, null: false) を追加する1つのマイグレーション。

##### 2. モデル変更

NotificationWebhook, NotificationEmail の2モデル:
- `validates :notify_hour, inclusion: { in: 0..23 }` を追加
- `.notify` クラスメソッドに `.where(notify_hour: Time.current.hour)` フィルタを追加

```ruby
# 例: NotificationWebhook
class << self
  def notify
    where(notify_hour: Time.current.hour).find_each { NotificationWebhookNotifierJob.perform_later(_1.id) }
  end
end
```

ChannelGroupWebhook は変更なし（毎時全件通知を維持）。

##### 3. Dispatcher Job 作成（3つ）

`.notify` クラスメソッドを呼ぶだけの薄いジョブを新規作成:
- `NotificationWebhookDispatcherJob`
- `NotificationEmailDispatcherJob`
- `ChannelGroupWebhookDispatcherJob`

##### 4. `config/recurring.yml` にタスク追加

```yaml
notification_webhook_dispatcher:
  class: NotificationWebhookDispatcherJob
  schedule: "0 * * * *"

notification_email_dispatcher:
  class: NotificationEmailDispatcherJob
  schedule: "0 * * * *"

channel_group_webhook_dispatcher:
  class: ChannelGroupWebhookDispatcherJob
  schedule: "20 * * * *"
```

##### 5. コントローラー変更

Strong Parameters に `:notify_hour` を追加（NotificationWebhooks, NotificationEmails の2コントローラー）。

##### 6. ビュー変更

`app/views/my/notification_settings/index.html.erb` の NotificationWebhook, NotificationEmail のフォームに `notify_hour` の select を追加。
テーブルにも「Notify Hour」列を追加。

#### 将来構想: `has_many :notification_schedules`

現在は `notify_hour` integer カラムで1日1回の時間指定だが、将来的には polymorphic な `NotificationSchedule` モデルで複数時間を指定できるようにする案がある。

- 0〜23時のチェックボックスUIで、通知したい時間を複数選択可能にする
- ChannelGroupWebhook も統一的に扱える（全時間チェック = 毎時通知）
- 「7時と19時に通知」のようなユースケースに対応できる

### B. Channel adjustment ジョブの統合

#### 方針

`ChannelIntervalAdjustmentJob`（毎日3am）と `ChannelScheduleAdjustmentJob`（毎日4am）を廃止し、
`ChannelItemsUpdaterJob` のfetch後に個別チャンネル単位で実行するように統合する。

- 全チャンネルを一括adjustするバッチから、fetch直後に都度adjustする方式へ変更
- fetch結果を反映したリアルタイムなadjustmentが可能になる
- `recurring.yml` から2件削除、Jobファイルも2つ削除でスッキリ

#### 現状

```
[recurring.yml] → ChannelItemsFetcherJob（毎時 :10, :59）
                    → Channel.fetch_and_save_items
                      → ChannelItemsUpdaterJob（チャンネルごと）
                        → channel.update_info
                        → channel.fetch_and_save_items
                        → channel.mark_items_checked!

[recurring.yml] → ChannelIntervalAdjustmentJob（毎日 3am）
                    → Channel.adjust_all_check_intervals
                      → 全チャンネルの set_check_interval!

[recurring.yml] → ChannelScheduleAdjustmentJob（毎日 4am）
                    → Channel.adjust_all_schedules!
                      → 全チャンネルの adjust_schedules!
```

#### 変更後

```
[recurring.yml] → ChannelItemsFetcherJob（毎時 :10, :59）
                    → Channel.fetch_and_save_items
                      → ChannelItemsUpdaterJob（チャンネルごと）
                        → channel.update_info
                        → channel.fetch_and_save_items
                        → channel.mark_items_checked!
                        → channel.set_check_interval!   ← 追加
                        → channel.adjust_schedules!      ← 追加
```

#### 実装ステップ

##### 1. `ChannelItemsUpdaterJob` に adjustment 処理を追加

`mark_items_checked!` の後に `set_check_interval!` と `adjust_schedules!` を呼ぶ。
既存と同様に `begin/rescue` で囲み、エラー時はSentryに送信しつつ後続処理を止めない。

##### 2. `recurring.yml` から2件削除

- `channel_interval_adjustment`
- `channel_schedule_adjustment`

##### 3. 不要になったJobとクラスメソッドの削除

- `app/jobs/channel_interval_adjustment_job.rb`
- `app/jobs/channel_schedule_adjustment_job.rb`
- `Channel.adjust_all_check_intervals`（クラスメソッド）
- `Channel.adjust_all_schedules!`（クラスメソッド）

### C. Heroku Scheduler → Solid Queue 移行後の `recurring.yml`

```yaml
channel_fetcher:
  class: ChannelItemsFetcherJob
  schedule: "10,59 * * * *"

notification_webhook_dispatcher:
  class: NotificationWebhookDispatcherJob
  schedule: "0 * * * *"

notification_email_dispatcher:
  class: NotificationEmailDispatcherJob
  schedule: "0 * * * *"

channel_group_webhook_dispatcher:
  class: ChannelGroupWebhookDispatcherJob
  schedule: "20 * * * *"

solid_queue_cleanup:
  class: SolidQueueCleanupJob
  schedule: "30 4 * * *"

daily_active_users_notifier:
  class: DailyActiveUsersNotifierJob
  schedule: "5 0 * * *"
```

Heroku Scheduler の通知系3件は、Solid Queue 移行後に削除する。
