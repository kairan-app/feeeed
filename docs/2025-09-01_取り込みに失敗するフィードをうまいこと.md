# フィード正規化フィルタシステム設計書

## 1. 背景と問題提起

### 1.1 現状の課題
GitHub Issue #362にて、複数のフィードが登録できない問題が報告されている。現在のChannelモデルは、厳格なバリデーションにより「正しい」フィードのみを受け入れる設計となっているが、実際のWebには様々な「不完全な」フィードが存在する。

### 1.2 報告されている問題のあるフィード
- https://www.ryuzee.com/feed
- https://www.ele-king.net/
- https://www.festival-life.com
- https://www.nan1.casa/index.xml
- https://tbsmcd.net/index.xml
- https://cast.kwappa.net/feed.xml
- https://feeds.megaphone.fm/guildtalk

## 2. 調査結果

### 2.1 発見された問題パターン

#### パターン1: 相対URL問題
**事例**: tbsmcd.net/index.xml
```xml
<link>/</link>  <!-- 相対パスになっている -->
<item>
  <link>/post/playwright-mcp-with-selfmade-mcp/</link>
</item>
```
**影響**:
- `UrlHttpValidator`がバリデーションエラーを起こす
- OpenGraph取得時にTCP接続エラー

#### パターン2: Atom名前空間の誤り
**事例**: ele-king.net/atom.xml
```xml
<feed xmlns="https://www.w3.org/2005/Atom">  <!-- httpsではなくhttpが正しい -->
```
**影響**: Feedjira::NoParserAvailableエラー

#### パターン3: 空のフィールド
**事例**: festival-life.com/feed
```xml
<title></title>  <!-- タイトルが空 -->
```
**影響**: Channelモデルのバリデーションエラー

#### パターン4: URLフィールドの欠落
**事例**: feeds.megaphone.fm/guildtalk
- feed.urlがnilになる
- エントリーのURLも取得できない

## 3. 提案するソリューション：フィード正規化フィルタシステム

### 3.1 基本コンセプト
「不完全なフィードを拒否する」のではなく「修正可能な問題は自動修正し、その履歴を記録する」アプローチを採用する。

### 3.2 アーキテクチャ概要

```
[外部フィード URL]
        ↓
[FeedFetcher]
    HTTPリクエストでコンテンツ取得
        ↓
[FeedNormalizer] ← フィルタパイプライン管理
    ├─ RelativeUrlResolver
    ├─ AtomNamespaceFixer
    ├─ EmptyFieldFiller
    ├─ InvalidXmlFixer
    └─ CharacterEncodingFixer
        ↓
[正規化されたコンテンツ]
        ↓
[Feedjira.parse]
        ↓
[Channel.build_from]
        ↓
[保存（フィルタ履歴も記録）]
```

### 3.3 設計原則

1. **単一責任の原則**: 各フィルタは特定の問題のみを解決
2. **透明性**: 適用されたフィルタと修正内容を記録
3. **非破壊的**: 元のデータを保持し、変更履歴を追跡可能
4. **段階的適用**: 必要なフィルタのみを選択的に適用

## 4. フィルタクラス設計

### 4.1 基底クラス
```ruby
module FeedFilters
  class Base
    attr_reader :applied, :details

    def initialize(options = {})
      @applied = false
      @details = {}
    end

    def applicable?(content, metadata = {})
      raise NotImplementedError
    end

    def apply(content, metadata = {})
      raise NotImplementedError
    end
  end
end
```

### 4.2 個別フィルタクラス

#### RelativeUrlResolver
**責務**: 相対URLを絶対URLに変換
**対象**: tbsmcd.net等
```ruby
class RelativeUrlResolver < Base
  def applicable?(content, metadata = {})
    # <link>タグに相対パスが含まれているかチェック
  end

  def apply(content, metadata = {})
    base_url = metadata[:url]
    # 相対パスを絶対パスに変換
    @details = {
      converted_paths: [
        { from: "/", to: "https://example.com/" }
      ]
    }
  end
end
```

#### AtomNamespaceFixer
**責務**: Atom XMLの名前空間を修正
**対象**: ele-king.net等
```ruby
class AtomNamespaceFixer < Base
  def apply(content, metadata = {})
    # xmlns="https://..." を xmlns="http://..." に修正
    @details = {
      fixed: "Atom namespace URL protocol"
    }
  end
end
```

#### EmptyFieldFiller
**責務**: 空のフィールドにデフォルト値を設定
**対象**: festival-life.com等
```ruby
class EmptyFieldFiller < Base
  def apply(content, metadata = {})
    # 空のtitleタグに適切な値を設定
    @details = {
      filled_fields: {
        title: "Festival Life"
      }
    }
  end
end
```

## 5. データベース設計

### 5.1 channelsテーブルへの追加カラム

```ruby
class AddFilterInfoToChannels < ActiveRecord::Migration[7.0]
  def change
    add_column :channels, :applied_filters, :json, default: []
    add_column :channels, :filter_details, :json, default: {}
  end
end
```

### 5.2 データ構造例

```json
{
  "applied_filters": [
    "RelativeUrlResolver",
    "EmptyFieldFiller"
  ],
  "filter_details": {
    "RelativeUrlResolver": {
      "converted_paths": [
        { "from": "/", "to": "https://tbsmcd.net/" },
        { "from": "/post/...", "to": "https://tbsmcd.net/post/..." }
      ]
    },
    "EmptyFieldFiller": {
      "filled_fields": {
        "title": "Default Title"
      }
    }
  }
}
```

## 6. UI/UX設計

### 6.1 Channelページでの表示

```erb
<% if @channel.applied_filters.any? %>
  <div class="alert alert-info">
    <h4>⚠️ このフィードには以下の修正が自動適用されています：</h4>

    <% @channel.applied_filters.each do |filter_name| %>
      <div class="filter-info">
        <h5><%= filter_name.humanize %></h5>
        <%= render_filter_details(filter_name, @channel.filter_details[filter_name]) %>
      </div>
    <% end %>

    <div class="mt-3">
      <strong>💡 フィード提供者の方へ：</strong>
      <p>これらの問題を修正いただけると、より多くのフィードリーダーで正しく表示されるようになります。</p>
    </div>
  </div>
<% end %>
```

### 6.2 統計ページ（将来的な拡張）

- 最も多く適用されているフィルタのランキング
- フィルタなしで登録できた「健全な」フィードの割合
- 時系列での改善傾向グラフ

## 7. 実装手順

### Phase 1: 基盤構築
1. データベースマイグレーション
2. フィルタ基底クラスの実装
3. FeedNormalizerサービスの実装

### Phase 2: 個別フィルタ実装
1. RelativeUrlResolver（最優先）
2. AtomNamespaceFixer
3. EmptyFieldFiller
4. その他のフィルタ

### Phase 3: 統合とUI
1. Channelモデルへの統合
2. UI表示の実装
3. テストの追加

## 8. 期待される効果

### 8.1 直接的効果
- 現在登録できないフィードの多くが登録可能になる
- ユーザーの利便性向上
- サポート対応の削減

### 8.2 間接的効果
- フィード提供者への品質改善のフィードバック
- Webフィードエコシステム全体の健全化への貢献
- 「修正して受け入れる」という寛容な設計思想の実現

## 9. 今後の拡張可能性

- 機械学習を用いた自動フィルタ選択
- フィード品質スコアリング
- フィード提供者向けの診断ツール
- コミュニティによるフィルタ開発

## 10. まとめ

このフィード正規化フィルタシステムは、単なる技術的な問題解決を超えて、Webフィードエコシステム全体の品質向上に貢献する「世直し」的な取り組みとなる。invalidなフィードを拒否するのではなく、修正可能な問題は自動的に解決し、その過程を透明化することで、フィード提供者とフィード利用者の双方にメリットをもたらす設計となっている。
