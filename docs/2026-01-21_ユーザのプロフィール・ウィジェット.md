# ユーザのプロフィール・ウィジェット

このアプリケーションの利用者には、ふたつの側面がある。

- Publisher
  - フィードの発信者
  - ブログを書いたり、ポッドキャストを更新したり
- Subscriber
  - フィードの受信者
  - ブログやポッドキャストなどなどを購読する

なのでusers#showにおいては、このふたつの側面をうまく扱えるとうれしい。この側面の比重は利用者ごとに異なっていて、たとえば「発信はしていないが、たくさん受信している」という人もいるし、もちろんそれについて良し悪しはない。

Publisherである人も、Subscriberである人も、その両面を持つ人も、その人の「フィードにまつわる人柄」がうまく表現されるページにしたい。

## ウィジェット構想

開発者として、ユーザ向けにいくつかのプロフィール・ウィジェットを提供したい。たとえば、

- Owned Channels
  - 発信を行っているChannelの一覧
- Owned Channel Recent Items
  - 発信を行っているChannelの新着Itemのリスト
- Subscribed Channels
  - 購読しているChannelの一覧
- Publish Punchcard
  - GitHubのコミットグラフのように、どれくらいの発信を行っているかを可視化するもの
- Pawprints Punchcard
  - GitHubのコミットグラフのように、どれくらいのItemを受信しているかを可視化するもの

などを想定していて、ひとりひとりのユーザが好きなウィジェットを選んで自分のページに表示できるようにしたい。

これによって、発信者としての自分や、受信者としての自分を、見せたいように見せることができると考えている。

## 設計

### データモデル

```
┌─────────────────────────────────────────────────────────────┐
│                        User                                  │
│  id, name, ...                                              │
└─────────────────────────────────────────────────────────────┘
                              │
                              │ has_many :profile_widgets
                              ▼
┌─────────────────────────────────────────────────────────────┐
│                  UserProfileWidget                           │
│  id                                                          │
│  user_id        : integer (FK, not null)                    │
│  widget_type    : string  (enum, not null)                  │
│  position       : integer (not null, default: 0)            │
│  created_at                                                  │
│  updated_at                                                  │
│                                                              │
│  unique index: [user_id, widget_type]                       │
│  index: [user_id, position]                                 │
└─────────────────────────────────────────────────────────────┘
```

- モデル名は `UserProfileWidget`、テーブル名は `user_profile_widgets`
- User モデルからは `user.profile_widgets` でアクセスできるようにする
- 同一ユーザーが同じ widget_type を複数持つことはできない（unique制約）
- position で表示順序を管理する
- position の管理は `acts_as_list` 等の gem を使わず自前で実装する（ウィジェット数が最大5種類と限定的なため）

### widget_type

| widget_type | 説明 |
|-------------|------|
| `owned_channels` | 発信を行っているChannelの一覧 |
| `owned_channel_recent_items` | 発信を行っているChannelの新着Itemのリスト |
| `subscribed_channels` | 購読しているChannelの一覧 |
| `publish_punchcard` | 発信活動の可視化（GitHubのコミットグラフ風） |
| `pawprints_punchcard` | 受信活動（Pawprints）の可視化 |

### ビューのパーシャル配置

```
app/views/user_profile_widgets/
├── _owned_channels.html.erb
├── _owned_channel_recent_items.html.erb
├── _subscribed_channels.html.erb
├── _publish_punchcard.html.erb
└── _pawprints_punchcard.html.erb
```

### 実装フェーズ

| Phase | 内容 |
|-------|------|
| 1 | `UserProfileWidget` モデル作成、マイグレーション |
| 2 | 管理画面（有効化/無効化/並び替え） |
| 3 | `owned_channels` / `subscribed_channels` ウィジェット |
| 4 | `owned_channel_recent_items` ウィジェット |
| 5 | `publish_punchcard` / `pawprints_punchcard` ウィジェット |
